<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE è²¼åœ–è‡ªå‹•ç”Ÿæˆå™¨</title>
  <style>
    :root {
      --primary-color: #06c755;
      --primary-hover: #05b34c;
      --secondary-color: #5b21b6;
      --danger-color: #ef4444;
      --bg-gradient: linear-gradient(135deg, #f0fdf4 0%, #e0e7ff 100%);
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border-color: rgba(226, 232, 240, 0.8);
      --success-color: #10b981;
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', 'Noto Sans TC', -apple-system, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      line-height: 1.6;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      color: var(--text-main);
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--text-sub);
      font-size: 16px;
      font-weight: 400;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--glass-shadow);
      border: 1px solid var(--border-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 12px 48px 0 rgba(31, 38, 135, 0.1);
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary-color);
      color: white;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
    }

    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.5);
    }

    .upload-area:hover {
      border-color: var(--primary-color);
      background: rgba(6, 199, 85, 0.08);
      transform: translateY(-2px);
    }

    .upload-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .upload-text {
      color: var(--text-sub);
      font-weight: 500;
    }

    .preview-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    .preview-box {
      background: white;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .preview-box img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      border-radius: 8px;
    }

    .preview-label {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-sub);
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      font-size: 18px;
      padding: 18px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(6, 199, 85, 0.3);
      width: 100%;
    }

    .btn-secondary {
      background: white;
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 12px 20px;
      border-radius: 12px;
    }

    .btn-secondary:hover {
      background: #f8fafc;
    }

    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .selection-card {
      padding: 40px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: 2px solid transparent;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .selection-card:hover {
      border-color: var(--primary-color);
      background: rgba(6, 199, 85, 0.02);
      transform: translateY(-4px);
    }

    .selection-card i {
      font-size: 48px;
    }

    .mode-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-option {
      flex: 1;
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-option:hover {
      border-color: var(--primary-color);
      background: rgba(6, 199, 85, 0.05);
    }

    .mode-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin-right: 8px;
    }

    .mode-option.selected {
      border-color: var(--primary-color);
      background: rgba(6, 199, 85, 0.1);
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 16px;
      margin-bottom: 20px;
    }

    details {
      margin-bottom: 16px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary-color);
      user-select: none;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary::before {
      content: 'â–¶ ';
      display: inline-block;
      transition: transform 0.3s;
    }

    details[open] summary::before {
      transform: rotate(90deg);
    }

    .prompt-content {
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.8;
      color: #333;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      background: white;
      padding: 12px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }

    .progress-container {
      display: none;
      margin-top: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color));
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .progress-text {
      text-align: center;
      color: var(--text-sub);
      font-size: 14px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .result-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      background: white;
    }

    .result-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .result-title {
      font-size: 12px;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .result-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .status-success {
      background: #f6ffed;
      color: var(--success-color);
    }

    .status-failed {
      background: #fff1f0;
      color: var(--danger-color);
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* ä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
    .btn-download {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: var(--success-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      margin-top: 8px;
      width: 100%;
    }

    .btn-download:hover {
      background: #389e0d;
      transform: translateY(-1px);
    }

    .btn-download svg {
      width: 14px;
      height: 14px;
    }

    .alert-info {
      background: #e6f7ff;
      color: #0958d9;
      border: 1px solid #91d5ff;
    }

    .alert-warning {
      background: #fffbe6;
      color: #d48806;
      border: 1px solid #ffe58f;
    }

    .alert-success {
      background: #f6ffed;
      color: #389e0d;
      border: 1px solid #b7eb8f;
    }

    input[type="file"] {
      display: none;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .preview-container {
        flex-direction: column;
      }

      .mode-selector {
        flex-direction: column;
      }

      .results-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>LINE è²¼åœ–ç¸½å‹•å“¡</h1>
      <p class="subtitle" id="mainSubtitle">å¿«é€Ÿå‰µä½œå±¬æ–¼æ‚¨çš„ 40 å¼µ LINE è²¼åœ–</p>
    </header>

    <!-- Path Selector -->
    <div id="selectionSection">
      <div class="selection-grid">
        <div class="selection-card" onclick="startFlow(1)">
          <div style="font-size: 48px;">ğŸ¨</div>
          <div style="font-size: 20px; font-weight: 700;">ç”Ÿæˆå…¨æ–° LINE è²¼åœ–</div>
          <p style="color: var(--text-sub); font-size: 14px;">æˆ‘åªæœ‰ä¸€å¼µè§’è‰²ç…§ç‰‡ï¼Œæƒ³è¨­è¨ˆæ–°çš„è²¼åœ–é¢¨æ ¼</p>
        </div>
        <div class="selection-card" onclick="startFlow(2)">
          <div style="font-size: 48px;">ğŸš€</div>
          <div style="font-size: 20px; font-weight: 700;">æ—¢æœ‰èƒŒæ™¯ + åƒè€ƒåœ–çºŒä½œ</div>
          <p style="color: var(--text-sub); font-size: 14px;">æˆ‘å·²ç¶“æœ‰æ¯åœ–è·Ÿæ»¿æ„çš„åƒè€ƒåœ–ï¼Œç›´æ¥ç”Ÿç”¢æ‰¹æ¬¡</p>
        </div>
      </div>
    </div>

    <!-- Flow 1: New Creation -->
    <div id="flow1Section" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div class="card-title" style="margin-bottom: 0;">
            <span class="step-number">1</span> è§’è‰²ç…§ç‰‡ (æ¯åœ–)
          </div>
          <button class="btn-secondary" onclick="backToSelection()">â† è¿”å›è·¯å¾‘é¸æ“‡</button>
        </div>
        <div class="upload-area" id="f1_motherUploadArea">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-text">é»æ“Šä¸Šå‚³æˆ–å°‡ç…§ç‰‡æ‹–æ›³è‡³æ­¤</div>
          <input type="file" id="f1_motherImageInput" accept="image/*" class="hidden">
        </div>
        <div id="f1_motherPreviewContainer" class="hidden">
          <div class="preview-box" style="max-width: 300px; margin: 30px auto 0;">
            <img id="f1_motherPreview" src="" alt="Mother image preview">
            <p class="preview-label">æ¯åœ– (å”¯ä¸€èº«ä»½å®šç¾©)</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span class="step-number">2</span> é¢¨æ ¼æ–¹æ¡ˆç™¼æƒ³
        </div>
        <p style="margin-bottom: 24px; color: var(--text-sub); font-size: 14px;">æˆ‘å€‘å°‡ä½¿ç”¨ 5
          ç¨®å°ˆé–€èª¿æ ¡çš„å¯«å¯¦ç´ æé¢¨æ ¼ç‚ºæ‚¨ç”¢ç”Ÿé è¦½ï¼Œè«‹ä¸Šå‚³ç…§ç‰‡å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼š</p>

        <button id="f1_generateBaseBtn" class="btn-primary" disabled>
          âœ¨ ä¸€æ¬¡ç™¼æƒ³ 5 ç¨®é¢¨æ ¼é è¦½
        </button>

        <div id="f1_stylesGrid" class="hidden"
          style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-top: 32px;">
          <!-- JS will populate cards here -->
        </div>

        <div id="f1_regenerateRow" class="hidden"
          style="margin-top: 40px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 32px;">
          <p style="color: var(--text-sub); margin-bottom: 16px; font-size: 14px;">å°ç›®å‰çš„çµæœä¸æ»¿æ„å—ï¼Ÿ</p>
          <button class="btn-secondary" onclick="retryBase()" style="padding: 12px 32px;">â™»ï¸ éƒ½ä¸å–œæ­¡ï¼Œé‡å•Ÿé¢¨æ ¼ç™¼æƒ³</button>
        </div>
      </div>

      <!-- Loading for Base Image -->
      <div id="f1_baseProcess" class="progress-container">
        <div class="progress-bar">
          <div id="f1_progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
        <p id="f1_progressText" class="progress-text">ChatGPT æ­£åœ¨ç‚ºæ‚¨æ§‹æ€ç¬¬ä¸€å¼µåœ–...</p>
      </div>

      <!-- Result of Base Image -->
      <div id="f1_baseResult" class="hidden"
        style="margin-top: 32px; border-top: 1px solid var(--border-color); padding-top: 32px; text-align: center;">
        <h3 style="margin-bottom: 24px;">é¢¨æ ¼åŸºæº–åœ–ç”Ÿæˆçµæœ</h3>
        <img id="f1_baseImage" src=""
          style="max-width: 300px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); border: 4px solid white;">
        <div style="margin-top: 32px; display: flex; gap: 16px; justify-content: center;">
          <button class="btn-secondary" onclick="retryBase()" style="padding: 14px 32px;">âŒ èª¿æ•´ Prompt</button>
          <button class="btn-primary" onclick="confirmBaseAndGoStep2()" style="width: auto; padding: 14px 48px;">âœ…
            å®Œç¾ï¼ä»¥æ­¤ç”Ÿç”¢å…¨å¥—</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Flow 2: Batch Production -->
  <div id="flow2Section" class="hidden">
    <!-- Upload Section -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div class="card-title" style="margin-bottom: 0;">
          <span class="step-number">1</span> æ ¸å¿ƒåŸºæº–ç¢ºèª
        </div>
        <button class="btn-secondary" onclick="backToSelection()">â† è¿”å›è·¯å¾‘é¸æ“‡</button>
      </div>

      <div id="f2_uploadAreas" style="display: flex; gap: 20px; margin-bottom: 24px;">
        <div class="upload-area" id="motherUploadArea" style="flex: 1; padding: 30px;">
          <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“·</div>
          <div class="upload-text">ä¸Šå‚³æ¯åœ–</div>
        </div>
        <div class="upload-area" id="anchorUploadArea" style="flex: 1; padding: 30px;">
          <div style="font-size: 40px; margin-bottom: 8px;">ğŸ¯</div>
          <div class="upload-text">ä¸Šå‚³éŒ¨é»åœ–</div>
        </div>
      </div>

      <div class="preview-container hidden" id="previewContainer">
        <div class="preview-box">
          <img id="motherPreview" src="" alt="Mother image preview">
          <div class="preview-label">æ¯åœ– (åŸå§‹è§’è‰²)</div>
          <input type="file" id="motherImageInput" accept="image/*" class="hidden">
        </div>
        <div class="preview-box">
          <img id="anchorPreview" src="" alt="Anchor image preview">
          <div class="preview-label">éŒ¨é»åœ– (é¢¨æ ¼åƒè€ƒ)</div>
          <input type="file" id="anchorImageInput" accept="image/*" class="hidden">
        </div>
      </div>
    </div>

    <!-- åŸæœ‰ç”Ÿæˆé¸é …å€ -->
    <div class="card">
      <div class="card-title"><span class="step-number">2</span> ç”Ÿæˆè¨­å®š</div>

      <div class="mode-selector">
        <label class="mode-option selected" id="modeAll"><input type="radio" name="generateMode" value="all" checked>
          <div>å…¨éƒ¨ 40 å¼µ</div>
        </label>
        <label class="mode-option" id="modeMultiple"><input type="radio" name="generateMode" value="multiple">
          <div>é¸æ“‡å‹•ä½œ</div>
        </label>
      </div>

      <div id="multipleSelectContainer" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <label style="font-weight: 600;">é¸æ“‡è¦ç”Ÿæˆçš„å‹•ä½œ</label>
          <div style="display: flex; gap: 8px;">
            <button type="button" id="selectAllBtn"
              style="padding: 6px 12px; font-size: 12px; background: #f0f0f0;">å…¨é¸</button>
            <button type="button" id="deselectAllBtn"
              style="padding: 6px 12px; font-size: 12px; background: #f0f0f0;">å–æ¶ˆ</button>
          </div>
        </div>
        <div id="stickerCheckboxList"
          style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px;">
        </div>
        <div style="margin-top: 8px; font-size: 13px; color: var(--text-sub);">å·²é¸æ“‡ï¼š<span id="selectedCount"
            style="font-weight:600; color:var(--primary-color);">0</span> å¼µ</div>
      </div>

      <details style="margin-top: 15px;">
        <summary>ğŸ“ Prompt ç·¨è¼¯ (é€²éš)</summary>
        <textarea id="promptText"
          style="width: 100%; min-height: 250px; margin-top: 10px; font-size: 12px; font-family: 'Courier New', monospace; line-height: 1.5; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button onclick="savePrompt()" style="flex: 1; font-size: 13px; background: #f5f5f5;">ğŸ’¾ å„²å­˜</button>
          <button onclick="resetPrompt()" style="flex: 1; font-size: 13px; background: #fff0f0; color: #f44;">ğŸ”„
            é‡ç½®</button>
        </div>
      </details>

      <button class="btn-primary" id="generateBtn" disabled style="margin-top: 20px;"><span id="generateBtnText">ğŸš€
          é–‹å§‹ç”Ÿç”¢è²¼åœ–</span></button>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
        <p class="progress-text" id="progressText">æº–å‚™ä¸­...</p>
      </div>
    </div>

    <div class="card hidden" id="resultsCard">
      <div class="card-title"><span class="step-number">3</span> ç”Ÿæˆçµæœ</div>
      <button class="btn-primary" id="downloadAllBtn" style="margin-bottom: 15px;">ğŸ“¦ ä¸‹è¼‰å…¨éƒ¨ (ZIP)</button>
      <div class="results-grid" id="resultsGrid"></div>
      <div style="margin-top: 32px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 24px;">
        <button class="btn-secondary" onclick="resetTaskAndGoHome()" style="padding: 12px 32px;">ğŸ  å›åˆ°é¦–é ä¸¦é–‹å§‹æ–°ä»»å‹™</button>
      </div>
    </div>
  </div>
  </div>

  <script>
    // --- åŸºç¤è³‡æ–™ï¼š5 å¤§å¯«å¯¦ç´ æé¢¨æ ¼ç¯„ä¾‹ ---
    const STYLES = {
      style1: {
        title: "é¢¨æ ¼ç¯„ä¾‹ä¸€ï½œå¯«å¯¦ç´ æ Ã— Qç‰ˆæ¯”ä¾‹",
        desc: "ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘\n  - å¯«å¯¦ç´ æé¢¨æ ¼\n  - å¯«å¯¦ç´ æç·šç¨¿ç‚ºä¸»ï¼Œç·šæ¢ä¹¾æ·¨ä¿äº®\n  - é ­éƒ¨ç•¥å¤§ï¼ˆç´„ 1.2ï½1.3 å€ï¼‰ï¼Œèº«é«”æ¯”ä¾‹ç°¡åŒ–\n  - è‡‰å‹èˆ‡äº”å®˜æ¯”ä¾‹å¿ æ–¼åŸæœ¬äººç‰©ï¼Œä¸è®Šå½¢\n  - è¡¨æƒ…èª‡å¼µä½†æ”¶æ–‚ï¼ˆå¤§ç¬‘ã€ç„¡å¥ˆã€é©šè¨ï¼‰\n  - è‰²å½©ï¼šä½é£½å’Œæš–è‰²æˆ–ç°éšï¼‹æ·¡æ·¡è…®ç´…\n  - é™°å½±ä»¥é‰›ç­†æšˆæŸ“æ„Ÿå‘ˆç¾ï¼Œä¸ç”¨å¼·å°æ¯”\n  - é©åˆä½œç‚º LINE åŸå‰µéœæ…‹è²¼åœ–"
      },
      style2: {
        title: "é¢¨æ ¼ç¯„ä¾‹äºŒï½œå¯«å¯¦ç´ æ Ã— è¡¨æƒ…ç‰¹åŒ–",
        desc: "ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘\n  - å¯«å¯¦ç´ æé¢¨æ ¼\n  - ç¶­æŒå¯«å¯¦ç´ æç­†è§¸\n  - è‡‰å‹ä¸è®Šï¼Œä½†ã€Œè¡¨æƒ…å¹…åº¦æ‹‰å¤§ã€\n  - çœ¼ç›çœå¤§ã€çœ‰æ¯›è§’åº¦èª‡å¼µ\n  - å˜´å‹èª‡é£¾ï¼ˆå¤§ç¬‘ã€å´©æ½°ã€æ€’ï¼‰\n  - å¯æ­é…ç°¡å–®å‹•ä½œç·šï¼ˆæ±—ã€æ°£æ³¡ã€æŠ–å‹•ç·šï¼‰\n  - é¡è‰²ä»ç„¶æŸ”å’Œï¼Œä¸ä½¿ç”¨è¢å…‰æˆ–å¼·çƒˆè‰²\n  - é©åˆä½œç‚ºèŠå¤©è¾¨è­˜åº¦é«˜ã€æƒ…ç·’ä¸€çœ¼æ‡‚çš„è²¼åœ–"
      },
      style3: {
        title: "é¢¨æ ¼ç¯„ä¾‹ä¸‰ï½œå¯«å¯¦ç´ æ Ã— å–®è‰²ç³»ä¸»é¡Œ",
        desc: "ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘\n  - å¯«å¯¦ç´ æé¢¨æ ¼\n  - å…¨å¥—è²¼åœ–çµ±ä¸€è‰²ç³»ï¼ˆä¾‹å¦‚ï¼šæš–ç°ã€å’–å•¡è‰²ã€è—ç°ï¼‰\n  - ç´ æç·šæ¢æ¸…æ¥šï¼Œä½†é™°å½±æ¥µç°¡\n  - è¡¨æƒ…åå…§æ–‚å¯æ„›ï¼ˆå¾®ç¬‘ã€æ·¡æ·¡ç„¡å¥ˆï¼‰\n  - å¹¾ä¹ä¸åŠ èƒŒæ™¯ï¼Œåªç•™ç™½æˆ–æ·¡åº•\n  - é©åˆä½œç‚ºåå¤§äººç”¨æˆ¶ã€è³ªæ„Ÿæˆç†Ÿçš„è²¼åœ–"
      },
      style4: {
        title: "é¢¨æ ¼ç¯„ä¾‹å››ï½œå¯«å¯¦ç´ æ Ã— æ‰‹å¯«å­—èåˆ",
        desc: "ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘\n  - å¯«å¯¦ç´ æé¢¨æ ¼\n  - æ­é…æ‰‹å¯«æ„Ÿæ–‡å­—ï¼ˆç²—é‰›ç­†ï¼ç²‰ç­†æ„Ÿï¼‰\n  - æ–‡å­—èˆ‡è¡¨æƒ…äº’å‹•ï¼ˆè²¼åœ¨æ—é‚Šæˆ–æ°£æ³¡å…§ï¼‰\n  - äººç‰©ç¶­æŒå¯«å¯¦ç´ æï¼Œé¡è‰²ç¶­æŒæŸ”å’Œï¼Œå­—é«”å¯ç¨æ·±ä¸€é»\n  - é©åˆä½œç‚ºéå¸¸ã€Œåƒ LINE è²¼åœ–ã€çš„å¯¦ç”¨æ¬¾"
      },
      style5: {
        title: "é¢¨æ ¼ç¯„ä¾‹äº”ï½œå¯«å¯¦ç´ æ Ã— å¯æ„›èª‡å¼µè‚¢é«”",
        desc: "ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘\n  - å¯«å¯¦ç´ æé¢¨æ ¼\n  - äººç‰©æ¯”ä¾‹ä¸è®Šï¼Œä½†è‚¢é«”å‹•ä½œæ”¾å¤§ï¼ˆæ¯”è®šã€æ®æ‰‹ã€å€’åœ°ï¼‰\n  - è¡¨æƒ…èˆ‡å‹•ä½œåŒæ­¥æ”¾å¤§æƒ…ç·’\n  - ç·šæ¢å¯ç•¥ç²—ä¸€é»ï¼Œå¢åŠ å°å°ºå¯¸è¾¨è­˜åº¦\n  - é©åˆä½œç‚ºä¸ç”¨å­—ä¹Ÿèƒ½ä¸€çœ¼çœ‹æ‡‚çš„å‹•ä½œå‹è²¼åœ–"
      }
    };

    const DEFAULT_PROMPT_TEMPLATE = `è«‹æ ¹æ“šæˆ‘ä¸Šå‚³çš„ã€Œæ¯åœ–ï¼ˆåŸå§‹è§’è‰²ç¯„ä¾‹ï¼‰ã€ä½œç‚º ã€è§’è‰²å”¯ä¸€èº«ä»½å®šç¾©ä¾†æºã€‘ï¼Œ ä»¥åŠæˆ‘ä¸Šå‚³çš„ã€ŒéŒ¨é»åœ–ï¼ˆå·²ç”Ÿæˆä¸”æœ€åƒçš„è§’è‰²åœ–ï¼‰ã€ä½œç‚º ã€é¢¨æ ¼èˆ‡æ¯”ä¾‹æ ¡æ­£åƒè€ƒã€‘ã€‚

ã€è§’è‰²ä¸€è‡´æ€§ï¼ˆæœ€é«˜å„ªå…ˆï¼‰ï½œå„ªåŒ–åˆè¦ç‰ˆã€‘
- å…¨å¥—è²¼åœ–åƒ…å‘ˆç¾åŒä¸€ä½å›ºå®šè§’è‰²ï¼Œä¸å¾—å‡ºç¾ç¬¬äºŒè§’è‰²æˆ–è§’è‰²è®Šé«”
- è§’è‰²çš„è‡‰éƒ¨çµæ§‹ã€äº”å®˜æ¯”ä¾‹ã€çœ¼å‹ã€é¼»å‹ã€å˜´å‹èˆ‡æ•´é«”æ°£è³ªéœ€åœ¨æ•´å¥—è²¼åœ–ä¸­ä¿æŒé«˜åº¦ä¸€è‡´èˆ‡ç©©å®š
- é«®å‹ã€é«®è‰²ã€æœè£ã€é…è‰²èˆ‡ç•«é¢¨éœ€ä¾æ“šã€Œæ¯åœ–ã€æ‰€å»ºç«‹çš„è§’è‰²è¨­å®šï¼Œä¸¦ä»¥ã€ŒéŒ¨é»åœ–ã€ä½œç‚ºæ¯”ä¾‹èˆ‡é¢¨æ ¼ä¸€è‡´æ€§çš„è¼”åŠ©åƒè€ƒ
- è‹¥æ¯åœ–èˆ‡éŒ¨é»åœ–ä¹‹é–“å‡ºç¾å·®ç•°ï¼Œè«‹ä»¥æ¯åœ–æ‰€å‘ˆç¾çš„è§’è‰²è¨­å®šç‚ºä¸»è¦ä¾å¾ªåŸºæº–
- ä¸å¾—é€²è¡Œè§’è‰²èåˆã€èª‡å¼µåŒ–è™•ç†æˆ–é¢¨æ ¼æ€§ç¾åŒ–ï¼Œè«‹ç¶­æŒè§’è‰²åŸæœ‰çš„æˆç†Ÿã€å…§æ–‚å¤–è§€ç‰¹è³ª
- ä¸å¾—æ–°å¢è§’è‰²ã€è¡ç”Ÿè§’è‰²ï¼Œæˆ–æ”¹è®Šæ—¢æœ‰è§’è‰²è¨­å®š

ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘
- å¯«å¯¦ç´ æé¢¨æ ¼
- ç·šæ¢æ¸…æ¥šã€é¡è‰²æŸ”å’Œ
- è¡¨æƒ…èª‡å¼µä½†å¯æ„›ï¼ˆä¸å¯ç ´å£è‡‰å‹èˆ‡äº”å®˜æ¯”ä¾‹ï¼‰
- é©åˆä½œç‚º LINE åŸå‰µéœæ…‹è²¼åœ–

ã€LINE å®˜æ–¹ä¸Šæ¶è¦ç¯„ï¼ˆå¿…é ˆéµå®ˆï¼‰ã€‘
- åœ–ç‰‡å°ºå¯¸ï¼š370 x 320 px
- åœ–ç‰‡æ ¼å¼ï¼šPNG
- èƒŒæ™¯ï¼šé€æ˜
- æª”æ¡ˆå¤§å°ï¼šå°æ–¼ 1MB
- è§’è‰²ä¸å¯è²¼é‚Šè£åˆ‡ï¼Œå››å‘¨ä¿ç•™å®‰å…¨é‚Šç•Œ
- è§’è‰²éœ€æ¸…æ¥šå¯è¾¨
- æ–‡å­—æ¸…æ¥šå¯è®€ï¼Œä¸å¯éå°
- ä¸å¯åŒ…å«ä»»ä½•å•†æ¨™ã€å“ç‰Œæˆ–ä¾µæ¬Šè§’è‰²

ã€æ§‹åœ–è¦æ±‚ã€‘
- å–®ä¸€è§’è‰²
- åŠèº«æˆ–å…¨èº«çš†å¯
- è§’è‰²ç½®ä¸­
- èƒŒæ™¯ä¿æŒé€æ˜

ã€é‡è¦é™åˆ¶ï¼ˆè«‹åš´æ ¼éµå®ˆï¼‰ã€‘
- è¡¨æƒ…èˆ‡å‹•ä½œåªèƒ½æ”¹è®Šã€Œè‚¢é«”èˆ‡æƒ…ç·’ã€ ä¸å¯æ”¹è®Šè‡‰å‹ã€äº”å®˜æ¯”ä¾‹æˆ–è§’è‰²æ°£è³ª
- ä¸å¯åŠ å…¥å¤šé¤˜ç‰©ä»¶æˆ–èƒŒæ™¯
- ä¸å¯æ”¹è®Šç•«é¢¨æˆ–é¢¨æ ¼

è«‹åªè¼¸å‡ºã€Œä¸€å¼µç¬¦åˆ LINE è¦ç¯„çš„è²¼åœ–åœ–ç‰‡ã€`;

    // --- è®Šæ•¸èˆ‡ç‹€æ…‹ ---
    let motherImageFile = null;
    let anchorImageFile = null;
    let allPresets = [];
    let currentTaskId = null;
    const LS_TASK_KEY = 'current_sticker_task_id';
    const LS_F1_TASKS_KEY = 'current_f1_task_ids'; // å„²å­˜ Flow 1 çš„ {styleKey: taskId}

    // --- åˆå§‹åŒ– ---
    window.addEventListener('load', () => {
      loadPresets();
      loadPrompt();
      checkSavedTask();
    });

    function checkSavedTask() {
      // 1. æª¢æŸ¥ Flow 2 (æ‰¹é‡ç”Ÿæˆ)
      const savedF2 = localStorage.getItem(LS_TASK_KEY);
      if (savedF2) {
        currentTaskId = savedF2;
        startFlow(2);
        document.getElementById('progressContainer').style.display = 'block';
        pollProgress();
        return;
      }

      // 2. æª¢æŸ¥ Flow 1 (é¢¨æ ¼ç™¼æƒ³)
      const savedF1 = localStorage.getItem(LS_F1_TASKS_KEY);
      if (savedF1) {
        const tasks = JSON.parse(savedF1);
        if (Object.keys(tasks).length > 0) {
          startFlow(1);
          f1StylesGrid.classList.remove('hidden');
          f1StylesGrid.innerHTML = '';
          // é€™è£¡éœ€è¦æ¯åœ–è·¯å¾‘æ‰èƒ½å®Œæ•´æ¢å¾©ï¼Œä½†å¦‚æœåˆ·æ–°äº†ï¼Œæ¯åœ– File ç‰©ä»¶æœƒä¸è¦‹
          // æ‰€ä»¥æ¢å¾©æ™‚åƒ…æ¢å¾©é€²åº¦å¡ç‰‡ï¼Œä¸å¸¶æ¯åœ–é è¦½ (æˆ–é‡æ–°ä¸Šå‚³)
          Object.keys(tasks).forEach(key => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.margin = '0';
            card.innerHTML = `
              <div style="font-weight:700; margin-bottom:12px; font-size:15px; color:var(--primary-color);">${STYLES[key].title}</div>
              <div id="img_container_${key}" style="width:100%; aspect-ratio:1; background:#f8fafc; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #e2e8f0; position:relative;">
                <div id="loader_${key}" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(59,130,246,0.05); color:var(--primary-color); font-size:13px; font-weight:600;">æ¢å¾©ä¸­...</div>
                <img id="img_${key}" class="hidden" style="width:100%; height:100%; object-fit:cover;">
              </div>
              <div id="status_${key}" style="font-size:12px; margin-top:10px; color:var(--text-sub); text-align:center;">æ¢å¾©é€²åº¦ä¸­...</div>
              <button id="btn_${key}" class="btn-primary hidden" style="margin-top:12px; font-size:13px; padding:10px;">âœ… æŒ‘é¸æ­¤é¢¨æ ¼</button>
            `;
            f1StylesGrid.appendChild(card);
            const selectBtn = card.querySelector(`#btn_${key}`);
            selectBtn.onclick = () => selectStyle(key);

            const finalPrompt = injectStyleIntoPrompt(DEFAULT_PROMPT_TEMPLATE, STYLES[key].desc);
            pollStyleStatus(key, tasks[key], finalPrompt);
          });
        }
      }
    }

    // --- å°å¼•è·¯å¾‘åˆ‡æ› ---
    function startFlow(num) {
      document.getElementById('selectionSection').classList.add('hidden');
      if (num === 1) {
        document.getElementById('flow1Section').classList.remove('hidden');
        document.getElementById('flow2Section').classList.add('hidden');
        document.getElementById('mainSubtitle').textContent = "Step: è¨­è¨ˆæ–°è§’è‰²çš„é¢¨æ ¼èˆ‡ç‰¹å¾µ";
      } else {
        document.getElementById('flow2Section').classList.remove('hidden');
        document.getElementById('flow1Section').classList.add('hidden');
        document.getElementById('mainSubtitle').textContent = "Step: æ­£å¼æ‰¹æ¬¡ç”Ÿç”¢ 40 å¼µè²¼åœ–";
      }
    }

    function backToSelection() {
      document.getElementById('selectionSection').classList.remove('hidden');
      document.getElementById('flow1Section').classList.add('hidden');
      document.getElementById('flow2Section').classList.add('hidden');
      document.getElementById('mainSubtitle').textContent = "å¿«é€Ÿå‰µä½œå±¬æ–¼æ‚¨çš„ 40 å¼µ LINE è²¼åœ–";
    }

    function resetTaskAndGoHome() {
      if (confirm('ç¢ºå®šè¦å›åˆ°é¦–é å—ï¼Ÿç›®å‰çš„ä»»å‹™è¨˜éŒ„å°‡æœƒè¢«æ¸…é™¤ã€‚')) {
        localStorage.removeItem(LS_TASK_KEY);
        currentTaskId = null;
        window.location.reload(); // é‡æ–°æ•´ç†ä»¥é‡ç½®æ‰€æœ‰ç‹€æ…‹
      }
    }

    // --- Flow 1: å…¨æ–°å‰µä½œé‚è¼¯ ---
    // --- Flow 1: å…¨æ–°å‰µä½œé‚è¼¯ ---
    const f1MotherInput = document.getElementById('f1_motherImageInput');
    const f1MotherPreview = document.getElementById('f1_motherPreview');
    const f1GenBtn = document.getElementById('f1_generateBaseBtn');
    const f1StylesGrid = document.getElementById('f1_stylesGrid');
    const f1RegenRow = document.getElementById('f1_regenerateRow');

    document.getElementById('f1_motherUploadArea').onclick = () => f1MotherInput.click();
    f1MotherInput.onchange = (e) => {
      if (e.target.files[0]) {
        motherImageFile = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (le) => {
          f1MotherPreview.src = le.target.result;
          document.getElementById('f1_motherPreviewContainer').classList.remove('hidden');
          checkF1Ready();
          initStyleGrid(); // ä¸Šå‚³å¾Œå³åˆ»åˆå§‹åŒ– 5 å€‹å¯ç·¨è¼¯æ–¹å¡Š
        };
        reader.readAsDataURL(motherImageFile);
      }
    };

    function initStyleGrid() {
      f1StylesGrid.classList.remove('hidden');
      f1StylesGrid.innerHTML = '';
      Object.keys(STYLES).forEach(key => {
        createStyleCard(key, STYLES[key]);
      });
    }

    function checkF1Ready() {
      f1GenBtn.disabled = !motherImageFile;
    }

    function injectStyleIntoPrompt(template, newStylePart) {
      const regex = /ã€ç•«é¢¨èˆ‡ç”¨é€”ã€‘[\s\S]*?(?=\nã€|$)/;
      return template.replace(regex, newStylePart);
    }

    f1GenBtn.onclick = async () => {
      try {
        f1GenBtn.disabled = true;
        f1RegenRow.classList.add('hidden');
        localStorage.removeItem(LS_F1_TASKS_KEY);

        // 1. ä¸Šå‚³æ¯åœ– (å¦‚æœé‚„æ²’æœ‰è·¯å¾‘)
        let mPath = window.f1_currentMPath;
        if (!mPath) {
          const fd = new FormData();
          fd.append('motherImage', motherImageFile);
          fd.append('anchorImage', motherImageFile);
          const upRes = await fetch('/api/upload', { method: 'POST', body: fd });
          const upData = await upRes.json();
          if (!upData.success) throw new Error(upData.error);
          mPath = upData.files.motherImage.path;
          window.f1_currentMPath = mPath;
        }

        // 2. å° 5 ç¨®é¢¨æ ¼åŒæ™‚å•Ÿå‹•ä»»å‹™
        Object.keys(STYLES).forEach((key) => {
          startStyleTask(key, mPath);
        });

      } catch (err) { alert(err.message); f1GenBtn.disabled = false; }
    };

    function createStyleCard(key, styleObj) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.margin = '0';
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      card.innerHTML = `
        <input id="title_${key}" type="text" value="${styleObj.title}" 
               style="width:100%; border:none; background:transparent; font-weight:700; margin-bottom:12px; font-size:15px; color:var(--primary-color); outline:none; border-bottom:1px solid transparent;"
               onfocus="this.style.borderBottom='1px solid var(--primary-color)'" 
               onblur="this.style.borderBottom='1px solid transparent'">
        
        <div id="img_container_${key}" style="width:100%; aspect-ratio:1; background:#f8fafc; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #e2e8f0; position:relative;">
          <div id="loader_${key}" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(59,130,246,0.05); color:var(--primary-color); font-size:13px; font-weight:600;">å¾…å•Ÿå‹•</div>
          <img id="img_${key}" class="hidden" style="width:100%; height:100%; object-fit:cover;">
        </div>
        
        <textarea id="desc_${key}" style="width:100%; flex:1; min-height:120px; font-size:12px; margin-top:12px; padding:8px; border-radius:8px; border:1px solid #eee; resize:none; font-family:inherit;">${styleObj.desc}</textarea>
        
        <div id="status_${key}" style="font-size:12px; margin-top:10px; color:var(--text-sub); text-align:center;">å°šæœªç”Ÿæˆ</div>
        
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="regen_${key}" class="btn-secondary" style="font-size:12px; padding:10px; flex:1;">â™»ï¸ é‡æ–°ç™¼æƒ³</button>
          <button id="btn_${key}" class="btn-primary hidden" style="font-size:12px; padding:10px; flex:1.5;">âœ… æŒ‘é¸æ­¤é¢¨æ ¼</button>
        </div>
      `;
      f1StylesGrid.appendChild(card);

      const selectBtn = card.querySelector(`#btn_${key}`);
      selectBtn.onclick = () => selectStyle(key);

      const regenBtn = card.querySelector(`#regen_${key}`);
      regenBtn.onclick = async () => {
        if (!motherImageFile) return alert('è«‹å…ˆä¸Šå‚³æ¯åœ–');

        // å¦‚æœæ²’æœ‰ä¸Šå‚³é
        if (!window.f1_currentMPath) {
          const fd = new FormData();
          fd.append('motherImage', motherImageFile);
          fd.append('anchorImage', motherImageFile);
          const upRes = await fetch('/api/upload', { method: 'POST', body: fd });
          const upData = await upRes.json();
          window.f1_currentMPath = upData.files.motherImage.path;
        }
        startStyleTask(key, window.f1_currentMPath);
      };
    }

    async function startStyleTask(key, mPath) {
      const statusText = document.getElementById(`status_${key}`);
      const loader = document.getElementById(`loader_${key}`);
      const regenBtn = document.getElementById(`regen_${key}`);
      const descArea = document.getElementById(`desc_${key}`);

      try {
        statusText.textContent = 'ä»»å‹™å•Ÿå‹•ä¸­...';
        loader.textContent = 'ğŸš€ è«‹æ±‚ç™¼é€ä¸­';
        regenBtn.disabled = true;

        const currentDesc = descArea.value.trim();
        const finalPrompt = injectStyleIntoPrompt(DEFAULT_PROMPT_TEMPLATE, currentDesc);

        const startRes = await fetch('/api/generate/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            motherImagePath: mPath,
            anchorImagePath: mPath,
            selectedPresets: [0],
            customPrompt: finalPrompt
          })
        });
        const startData = await startRes.json();

        // å„²å­˜ F1 ä»»å‹™åˆ° LS
        let tasks = JSON.parse(localStorage.getItem(LS_F1_TASKS_KEY) || '{}');
        tasks[key] = startData.taskId;
        localStorage.setItem(LS_F1_TASKS_KEY, JSON.stringify(tasks));

        pollStyleStatus(key, startData.taskId, finalPrompt);
      } catch (e) {
        statusText.textContent = 'å•Ÿå‹•å¤±æ•—';
        regenBtn.disabled = false;
      }
    }

    function pollStyleStatus(key, taskId, finalPrompt) {
      const statusText = document.getElementById(`status_${key}`);
      const loader = document.getElementById(`loader_${key}`);
      const img = document.getElementById(`img_${key}`);
      const btn = document.getElementById(`btn_${key}`);
      const regenBtn = document.getElementById(`regen_${key}`);

      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/api/generate/status/${taskId}`);
          const data = await res.json();
          const t = data.task;
          if (t.status === 'running') {
            statusText.textContent = 'ChatGPT ç”Ÿæˆä¸­...';
            loader.textContent = 'ğŸ–Œï¸ ç¹ªè£½ä¸­';
          } else if (t.status === 'completed' && t.results.length > 0) {
            clearInterval(interval);
            regenBtn.disabled = false;
            const ok = t.results.find(r => r.success);
            if (ok) {
              img.src = '/' + ok.path;
              img.classList.remove('hidden');
              loader.classList.add('hidden');
              statusText.textContent = 'ç”ŸæˆæˆåŠŸï¼';
              btn.classList.remove('hidden');
              btn.setAttribute('data-path', ok.path);
              btn.setAttribute('data-prompt', finalPrompt);
              checkAllFinished();
            } else {
              statusText.textContent = 'ç”Ÿæˆå¤±æ•—';
            }
          } else if (t.status === 'failed') {
            clearInterval(interval);
            regenBtn.disabled = false;
            statusText.textContent = 'ä»»å‹™å‡ºéŒ¯';
            checkAllFinished();
          }
        } catch (e) { }
      }, 4000);
    }

    function checkAllFinished() {
      const allCards = Object.keys(STYLES);
      const finished = allCards.every(key => {
        const txt = document.getElementById(`status_${key}`).textContent;
        return txt.includes('æˆåŠŸ') || txt.includes('å¤±æ•—') || txt.includes('å‡ºéŒ¯');
      });
      if (finished) {
        f1RegenRow.classList.remove('hidden');
        f1GenBtn.disabled = false;
        f1GenBtn.textContent = 'âœ¨ é‡æ–°ç™¼æƒ³ 5 ç¨®é¢¨æ ¼';
      }
    }

    function selectStyle(key) {
      localStorage.removeItem(LS_F1_TASKS_KEY); // é¸ä¸­å¾Œæ¸…é™¤ç™¼æƒ³å¿«å–
      const btn = document.getElementById(`btn_${key}`);
      window.currentAnchorPath = btn.getAttribute('data-path');
      window.currentPrompt = btn.getAttribute('data-prompt');

      document.getElementById('anchorPreview').src = '/' + window.currentAnchorPath;
      if (motherImageFile) {
        document.getElementById('motherPreview').src = f1MotherPreview.src;
      }
      document.getElementById('previewContainer').classList.remove('hidden');
      document.getElementById('f2_uploadAreas').classList.add('hidden');
      document.getElementById('promptText').value = window.currentPrompt;
      window.usePreUploadedAnchor = window.currentAnchorPath;

      startFlow(2);
      updateGenerateButton();
    }

    function retryBase() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤ç›®å‰çš„é è¦½ä¸¦é‡æ–°ç™¼æƒ³å—ï¼Ÿ')) {
        localStorage.removeItem(LS_F1_TASKS_KEY);
        f1StylesGrid.innerHTML = '';
        f1GenBtn.disabled = false;
        f1GenBtn.click();
      }
    }

    // --- Flow 2: æ‰¹æ¬¡ç”Ÿç”¢é‚è¼¯ ---
    const motherImageInput = document.getElementById('motherImageInput');
    const anchorImageInput = document.getElementById('anchorImageInput');
    const generateBtn = document.getElementById('generateBtn');
    const generateBtnText = document.getElementById('generateBtnText');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsGrid = document.getElementById('resultsGrid');
    const resultsCard = document.getElementById('resultsCard');
    const promptText = document.getElementById('promptText');

    document.getElementById('motherUploadArea').onclick = () => motherImageInput.click();
    document.getElementById('anchorUploadArea').onclick = () => anchorImageInput.click();

    motherImageInput.onchange = (e) => handleFile(e, 'mother');
    anchorImageInput.onchange = (e) => handleFile(e, 'anchor');

    function handleFile(e, type) {
      if (e.target.files[0]) {
        const file = e.target.files[0];
        if (type === 'mother') motherImageFile = file;
        else { anchorImageFile = file; window.usePreUploadedAnchor = null; }
        const r = new FileReader();
        r.onload = (le) => {
          document.getElementById(type + 'Preview').src = le.target.result;
          document.getElementById('previewContainer').classList.remove('hidden');
          document.getElementById('f2_uploadAreas').classList.add('hidden');
          updateGenerateButton();
        };
        r.readAsDataURL(file);
      }
    }

    async function loadPresets() {
      const res = await fetch('/presets.json');
      allPresets = await res.json();
      const list = document.getElementById('stickerCheckboxList');
      list.innerHTML = '';

      let currentCategory = "";
      allPresets.forEach((p, i) => {
        // æ’å…¥åˆ†é¡æ¨™é¡Œ
        if (p.category && p.category !== currentCategory) {
          currentCategory = p.category;
          const header = document.createElement('div');
          header.style.cssText = 'padding: 12px 8px 4px; font-weight: 800; color: var(--primary-color); font-size: 14px; border-bottom: 2px solid #f1f5f9; margin-top: 10px; background: #fafafa;';
          header.textContent = `ğŸ“‚ ${currentCategory}`;
          list.appendChild(header);
        }

        const lbl = document.createElement('label');
        lbl.style.cssText = 'display: flex; align-items: center; padding: 10px 8px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;';
        lbl.onmouseover = () => lbl.style.background = '#f8fafc';
        lbl.onmouseout = () => lbl.style.background = 'transparent';

        lbl.innerHTML = `<input type="checkbox" value="${i}" class="sticker-checkbox" style="width:18px; height:18px; margin-right:12px;"> 
                         <span style="font-size: 14px;">${p.title}</span>`;
        lbl.querySelector('input').onchange = updateSelectedCount;
        list.appendChild(lbl);
      });
    }

    function updateSelectedCount() {
      const cnt = document.querySelectorAll('.sticker-checkbox:checked').length;
      document.getElementById('selectedCount').textContent = cnt;
      updateGenerateButton();
    }

    document.getElementById('selectAllBtn').onclick = () => {
      document.querySelectorAll('.sticker-checkbox').forEach(c => c.checked = true);
      updateSelectedCount();
    };
    document.getElementById('deselectAllBtn').onclick = () => {
      document.querySelectorAll('.sticker-checkbox').forEach(c => c.checked = false);
      updateSelectedCount();
    };

    function updateGenerateButton() {
      const generateMode = document.querySelector('input[name="generateMode"]:checked');
      const mode = generateMode ? generateMode.value : 'all';
      const hasImg = motherImageFile && (anchorImageFile || window.usePreUploadedAnchor);
      const count = document.querySelectorAll('.sticker-checkbox:checked').length;
      if (mode === 'all') {
        generateBtnText.textContent = 'ğŸš€ é–‹å§‹æ‰¹æ¬¡ç”Ÿæˆå…¨å¥— 40 å¼µ';
        generateBtn.disabled = !hasImg;
      } else {
        generateBtnText.textContent = count > 0 ? `ğŸš€ ç”Ÿæˆé¸ä¸­çš„ ${count} å¼µ` : 'ğŸš€ è«‹å‹¾é¸å‹•ä½œ';
        generateBtn.disabled = !(hasImg && count > 0);
      }
    }

    document.querySelectorAll('input[name="generateMode"]').forEach(r => {
      r.onchange = () => {
        const container = document.getElementById('multipleSelectContainer');
        if (r.value === 'multiple') {
          container.classList.remove('hidden');
          document.getElementById('modeMultiple').classList.add('selected');
          document.getElementById('modeAll').classList.remove('selected');
        } else {
          container.classList.add('hidden');
          document.getElementById('modeAll').classList.add('selected');
          document.getElementById('modeMultiple').classList.remove('selected');
        }
        updateGenerateButton();
      };
    });

    generateBtn.onclick = async () => {
      try {
        generateBtn.disabled = true;
        document.getElementById('progressContainer').style.display = 'block';

        let mPath, aPath;
        if (window.usePreUploadedAnchor && !anchorImageFile) {
          const fd = new FormData();
          fd.append('motherImage', motherImageFile);
          fd.append('anchorImage', motherImageFile);
          const upRes = await fetch('/api/upload', { method: 'POST', body: fd });
          const upData = await upRes.json();
          mPath = upData.files.motherImage.path;
          aPath = window.usePreUploadedAnchor;
        } else {
          const fd = new FormData();
          fd.append('motherImage', motherImageFile);
          fd.append('anchorImage', anchorImageFile);
          const upRes = await fetch('/api/upload', { method: 'POST', body: fd });
          const upData = await upRes.json();
          if (!upData.success) throw new Error(upData.error);
          mPath = upData.files.motherImage.path;
          aPath = upData.files.anchorImage.path;
        }

        const mode = document.querySelector('input[name="generateMode"]:checked').value;
        const selected = mode === 'all' ? [] : Array.from(document.querySelectorAll('.sticker-checkbox:checked')).map(c => parseInt(c.value));

        const startRes = await fetch('/api/generate/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            motherImagePath: mPath,
            anchorImagePath: aPath,
            selectedPresets: selected,
            customPrompt: promptText.value.trim()
          })
        });
        const startData = await startRes.json();
        currentTaskId = startData.taskId;
        localStorage.setItem(LS_TASK_KEY, currentTaskId);
        pollProgress();
      } catch (e) { alert(e.message); generateBtn.disabled = false; }
    };

    async function pollProgress() {
      if (!currentTaskId) return;
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/api/generate/status/${currentTaskId}`);
          const data = await res.json();
          const t = data.task;
          if (t.status === 'running') {
            const p = Math.round((t.progress / t.total) * 100);
            progressFill.style.width = p + '%';
            progressFill.textContent = p + '%';
            progressText.textContent = `âš¡ ä»»å‹™åŠ é€Ÿä¸­: [${t.progress}/${t.total}] ${t.currentSticker}`;

            // å³æ™‚æ›´æ–°çµæœç¶²æ ¼
            if (t.results && t.results.length > 0) {
              showResults(t.results, true);
            }
          } else if (t.status === 'completed') {
            clearInterval(interval);
            showResults(t.results);
            // ä¸å†è‡ªå‹•ç§»é™¤ LS_TASK_KEYï¼Œè®“ä½¿ç”¨è€…é‡æ–°æ•´ç†ä¹Ÿèƒ½çœ‹åˆ°çµæœ
          } else if (t.status === 'failed') {
            clearInterval(interval);
            alert("ä»»å‹™ä¸­æ–·: " + t.error);
            generateBtn.disabled = false;
            // å¤±æ•—ä¹Ÿä¿ç•™ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç™¼ç”Ÿä»€éº¼äº‹
          }
        } catch (e) { }
      }, 3000);
    }

    function showResults(results, progressive = false) {
      const hasSuccess = results.some(r => r.success);
      if (!progressive || hasSuccess) resultsCard.classList.remove('hidden');
      // å¦‚æœä¸æ˜¯æ¼¸é€²å¼æ›´æ–°ï¼Œå‰‡æ¸…ç©ºç¶²æ ¼ï¼›æˆ–æ˜¯ç¶²æ ¼ç‚ºç©ºæ™‚
      if (!progressive || resultsGrid.innerHTML === '') {
        resultsGrid.innerHTML = '';
      }

      // æ¼¸é€²å¼æ›´æ–°æ™‚ï¼Œæˆ‘å€‘åªæ·»åŠ ã€Œå°šæœªåœ¨ç¶²æ ¼ä¸­ã€çš„åœ–
      results.forEach(r => {
        const existingImg = resultsGrid.querySelector(`img[src="/${r.path}"]`);
        if (existingImg) return; // å·²ç¶“é¡¯ç¤ºéäº†

        const div = document.createElement('div');
        div.className = 'result-item';
        div.style.background = 'white';
        div.style.padding = '12px';
        div.style.borderRadius = '12px';
        div.style.textAlign = 'center';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
        if (r.success) {
          const fname = r.path.split('/').pop();
          div.innerHTML = `<img src="/${r.path}" style="width:100%; border-radius:8px;">
                           <div style="font-size:12px; margin:8px 0; font-weight:600;">${r.title}</div>
                           <button class="btn-download" onclick="downloadSingle('${fname}')">ä¸‹è¼‰</button>`;
        } else {
          div.innerHTML = `<div style="height:100px; display:flex; align-items:center; justify-content:center; color:#ccc;">FAILED</div>
                           <div style="font-size:12px; margin:8px 0;">${r.title}</div>
                           <span style="color:var(--danger-color); font-size:11px;">ç”Ÿæˆç•°å¸¸</span>`;
        }
        resultsGrid.appendChild(div);
      });
      generateBtn.disabled = false;
    }

    function downloadSingle(f) { window.location.href = `/api/download/${currentTaskId}/${f}`; }
    document.getElementById('downloadAllBtn').onclick = () => { window.location.href = `/api/download-all/${currentTaskId}`; };

    function savePrompt() { localStorage.setItem('customPrompt', promptText.value); alert('æŒ‡ä»¤å·²å„²å­˜è‡³ç€è¦½å™¨'); }
    function resetPrompt() { if (confirm('ç¢ºå®šè¦æ¢å¾©é è¨­æŒ‡ä»¤å—ï¼Ÿ')) { promptText.value = DEFAULT_PROMPT_TEMPLATE; localStorage.removeItem('customPrompt'); } }
    function loadPrompt() {
      const s = localStorage.getItem('customPrompt');
      promptText.value = s ? s : DEFAULT_PROMPT_TEMPLATE;
    }
  </script>
</body>

</html>